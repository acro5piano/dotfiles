#!/bin/bash

set -eu

export PATH=$PATH:$HOME/.gem/ruby/2.4.0/bin/:$HOME/.local/bin

# TODO:
#     - yaml like package list or ansible playbook

install-dev-package(){
    sudo pacman -S --needed --noconfirm \
        fish vim inotify-tools bc make git tmux openssh \
        rsync tree curl jq man at ripgrep ctags zip unzip \
        yaourt docker docker-compose arch-install-scripts \
        ruby \
        python3 python-pip gcc-fortran lapack libpng \
        go \
        lua \
        php composer \
        nodejs npm \
        jdk8-openjdk \
        clojure

    yaourt -S \
        leiningen \
        android-platform android-sdk android-sdk-platform-tools android-sdk-build-tools android-platform-23

    # https://stackoverflow.com/questions/39760172/you-have-not-accepted-the-license-agreements-of-the-following-sdk-components
    android update sdk --no-ui --all --filter platform-tools,android-25,extra-android-m2repository
    android update sdk --no-ui --all --filter build-tools-23.0.1,android-23,extra-android-m2repository
}

install-verion-management-tool(){
    curl -o- https://raw.githubusercontent.com/creationix/nvm/master/install.sh | bash
}

install-termianl-tool(){
    go get \
        github.com/jehiah/json2csv \
        github.com/motemen/ghq
    which bundle   || gem install bundler pry
    which mycli    || pip install --user --upgrade virtualenv ipython mycli csvkit
    which yarn     || sudo npm install -g yarn exp create-react-app create-react-native-app vue-cli
    which electron     || sudo yarn install -g electron
    which psysh || composer global require psy/psysh
    which phpunit || composer global require phpunit/phpunit
    which pipenv || pip install --user pipenv

    sudo pacman -S --needed --noconfirm \
        graphviz transmission-cli rlwrap fzf tig netctl wpa_actiond expect \
        nmap traceroute openssl
    yaourt -S --needed --noconfirm nkf cmigemo-git
}

install-editor-plugin(){
    [ -e $HOME/.vim/plugged ] ||
        curl -fLo ~/.vim/autoload/plug.vim --create-dirs \
                https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
}

install-gui-package(){
    sudo pacman -S --needed  \
         xorg xorg-xinit wmctrl synaptics xorg-xbacklight awesome \
         fcitx fcitx-im fcitx-mozc fcitx-configtool \
         terminator chromium pcmanfm dmenu \
         xclip xdotool xscreensaver acpi pm-utils xcompmgr xfce4-screenshot \
         vlc feh pinta moc eog evince libreoffice-fresh ffmpeg wavpack inkscape \
         adobe-source-code-pro-fonts
    yaourt -S --needed \
        otf-ipaexfont  maim
}

install-xremap(){
    which xremap && return
    cd /tmp
    git clone https://github.com/k0kubun/xremap
    cd xremap
    make
    sudo make install
}

change-service(){
    start_and_enable(){
        sudo systemctl enable $1
        sudo systemctl restart $1
    }
    add_user_to_group(){
        id | grep -q $1 || sudo gpasswd -a $USER $1
    }
    add_user_to_group sys

    # Docker setting
    sudo systemctl daemon-reload
    add_user_to_group docker
    start_and_enable docker

    # Enable auto-connect wifi network
    sudo systemctl disable dhcpcd
    start_and_enable netctl
    start_and_enable netctl-auto@wlp3s0.service
    sudo netctl enable wlp3s0-Traimmu-AP
    sudo netctl enable redmi2

    sudo loginctl enable-linger kazuya
}

change-shell(){
    grep -q fish /etc/shells || echo /usr/bin/fish | sudo tee -a /etc/shells
    if [ $SHELL != /usr/bin/fish ]; then
        chsh -s /usr/bin/fish
    fi
}

install-dev-package && \
install-termianl-tool && \
install-editor-plugin && \
install-gui-package && \
install-xremap && \
change-service && \
change-shell
